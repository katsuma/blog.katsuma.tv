---
title: IE6でスワップした画像が描画されない
date: 2007/07/18
tags: javascript
published: true

---

<p>普段、prototype.jsの$関数（document.getElementByIdのショートカット関数）にどっぷりハマっていると、痛い目にあいますよ、な話。</p>

<p>JavaScriptで画像をスワップさせようとする場合、どうするでしょう？Ajaxゴリゴリなコードを書くことが多い僕はついつい$関数を利用して</p>

<p><pre>$('hoge').innerHTML = 'foo'</pre></p>
<p>のノリで</p>
<p><pre>$('hoge').src = 'foo.jpg'</pre></p>
<p>な、コードを書いてしまいます。</P>

<p>このコードは正しいことは正しい、、のですが、実際はうまく動作しません。厳密に言うと、<strong>IE6でのみ想定したような動作をしない</strong>場合があります。</p>

<p>たとえば、いくつかタブのように画像を並べて、クリックしたタブの画像だけをアクティブっぽい画像に、その他のタブの画像は非アクティブな画像にする、とします。その際に上記のようなコードを利用すると、IE6の場合のみ、スワップさせた画像領域が<strong>何も描画されなくなる</strong>場合があります。いきなり真っ白になって「え？？」と思い、右クリック→画像の表示、を行うと、そこで初めて画像が描画されます。要するにスワップした画像のレンダリングが追いついていないのです。これはIE7では（僕が体験した限り）起きることはありません。また、IE6でもスワップ対象の画像数が1つだとほぼ起きないですが、2つ以上になると途端に描画が不安定になります。</p>

<p>「キャッシュに残せばいいんじゃない？」と、いうことで、onload時にスワップ対象画像を全部loadさせる手もあるかと思いますが、それでも自体は（ほぼ）変わりません。「じゃぁどうすればいいの？」と、いう話になるのですが、困ったときは<原点回帰を行います。</p>

<h3>Imageオブジェクトを忘れない！</h3>
<p>エレメント操作を行う場合に、ついつい$関数で拡張エレメントを利用してしまうのですが、そもそもJavaScriptには画像を扱うための組み込みオブジェクトとして<strong>Imageオブジェクト</strong>があります。こいつを利用しない手はありません。つまり、こんなコードになります。超単純なコードですけど。</p>

<p><pre>
Image image = new Image('hoge');
hoge.src = 'foo.jpg';
</pre></p>

<p>これだと<strong>絶対に</strong>IE6でもレンダリングできます！</p>

<h3>検証</h3>
<p>ついでに検証コードをかいてみました。Imageオブジェクト経由のスワップと$関数を利用したスワップで、いかに露骨に違ってくるか、を確認してみてください。Firefoxだと違いは出ないと思うのでIE6がベストです。</p>

<h3>教訓</h3>
<p>ブラウザオブジェクトをおろそかにしない！！</p>
